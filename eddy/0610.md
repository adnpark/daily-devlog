# 거대 ViewController 해체하기 - 그러나 결국 해체되는 건 나였다

## Intro

iOS 개발을 배우면서 다양한 프로젝트를 진행해봤다. 그 과정에서 느낀 점이 있다. 프로젝트를 하나 하더라도, 내가 배우고 싶은 것 도전해보고 싶은 것을 명확하게 정하는 게 정말 중요하다. 

물론 일단 당장 기능 구현하는 것도 어렵다. 적당히 돌아가게 만들고 PR를 날리는 데 집중하게 된다. 일단은 돌아가게 만들고, 일단은 이것부터 하고...

하지만 실력이 늘기 위해서는, 단순한 기능 하나라도 더 나은 방법은 없을지 고민해봐야 한다. 그렇게 한 뎁스, 두 뎁스를 내려갔을 때 얻는 게 더 많다. 무엇을 만드는지는 사실 크게 중요하지 않다. 그러기 위해선 기능 구현이 아니라 내가 연습하려고 하는 부분을 명확하게 의식적으로 설정해야 한다. 그 부분을 고립시켜서 깊이있게 해보는 게 중요하다.

서론이 길었다. 이번 프로젝트에서 나의 학습 목표는 '단위 테스트와 리팩토링'이었다. 단일 책임 원칙을 잘 지키는 객체 지향 설계를 해보고 싶었다. 결과적으로 구현하는 데 3-4일 밖에 걸린 기능을 거진 2주 내내 리팩토링에 쏟아부었다. 

리팩토링을 하기 전의 코드는 마치 거대한 컴퓨터 뒤의 선 정리가 안 된, 온갖 멀티탭과 주변 기기들로 꽉 찬 모습을 모는 것만 같다. 이걸 어떻게 일관성있고, 갈아끼우기 쉽게 만들 수 있을까 고민하다가 굉장히 머리가 아팠다.

게다가 조금 정리를 해보려고 하면, 이쪽에서 파지직, 저쪽에서 파지직 부서지려고 하기 일쑤다.

그만큼 삽질도 많이 했다. 클릭 3번이면 끝나는 아주 사소한 기능이지만, 총 3번이나 구조를 갈아엎는 대공사를 했다. 결과적으로는 여태까지 만들었던 앱 중 가장 역할 분리가 잘 되고, 결합도가 낮은 구조를 만들 수 있었던 것 같다.


아마 2주 간의 여정이니 꽤 길겠지만, 압축해서 그 삽질의 과정을 기록해보려고 한다.

## 기능 소개

이번 프로젝트에 구현한 것은 에어비앤비 기능의 일부다. 위치 검색, 날짜 검색, 가격 검색을 통해서 원하는 숙박 조건을 설정하고, 그에 맞는 숙박 리스트를 받아오는 것이었음.

이 중에서도 오늘 얘기할 부분은, 위치 검색 기능이다.
흐름은 다음과 같다. 

초기 화면에서 서치 바를 탭하면 위치 검색 기능으로 진입한다. 추천 여행지가 콜렉션 뷰에 보여진다. 

이 중에서 하나를 고르게 되면 바로 Location Search가 끝나게 된다.

만약 고르지 않고 검색을 시작하면, 자동완성이 시작된다.
애플 MapKit에는 자동완성을 제공해주는 API가 있다. 이 데이터를 가져와서 콜렉션 뷰에 띄워준다.

자동완성 키워드 중 하나를 선택하면, 2가지 경우의 수가 존재한다.

해당 검색 키워드에 대한 장소 결과가 딱 하나밖에 없는 경우는 곧장 Location Search가 완료된다.

장소 결과가 여러개인 검색어, School이라든지, Coffee 같은 것들은 한번더 상세 검색 화면이 뜨게 된다. 

이제 키워드가 아닌 실제 장소가 뜬다. 이 장소를 선택하면 Location Search가 완료된다.

## 초창기 상태

M-V-C 구조로 만들어졌다. 이번 프로젝트의 목표 중 하나는 MVC를 하더라도 제대로 해보자는 것이었다. 흔히 MVC 패턴이 Massiv View controller를 만든다고 하지만, 꼭 그런 것은 아니다. 오히려 제대로 된 역할 분리를 안해줬기 때문인 경우가 많다.

현재는 아주 전형적인 거대 뷰 컨트롤러의 형태를 하고 있다. 
LocationSearchVC라는 하나의 객체가 다음의 역할을 모두 하고 있다.

- SearchBar, CollectionView에 대한 설정과 레이아웃 세팅
- CollectionView의 Delegate와 DataSource 역할
- MapKit과 Back-end에서 데이터 불러오기

 이제부터 이 거대 뷰 컨트롤러를 해체해보도록 하자!


## 리팩토링 1

1. DataSource 분리하기

2. 데이터 로딩 모델 분리하기

(문제) Struct 객체에서 비동기 데이터 불러오기

3. Delegate 분리하기

## 리팩토링 2

1. Delegate와 DataSource 합쳐서 하위 Controller로 만들기

2. 하위 컨트롤러에서 Delegate로 상위 컨트롤러에게 위임하기

(문제) 클로저로 할 것인가? 델리게이트로 할 것인가?

## 리팩토링 3

1. 프로토콜로 의존성 추상화 (역전)하기

2. DI Container로 의존성 주입하기

(문제) Protocol with Associated Type

## 결론

배운 점: 
- 리팩토링을 할 때는 항상 작은 스텝으로 해야 한다.
- 커뮤니케이션 패턴은 일관성 있게 해야 한다.
- 일관성 있는 네이밍은 너무너무 중요하다.