## 테스트 작성의 비용

사실 테스트가 중요하다는 것은 누구나 공감한다. 마치 건강을 위해 금연 금주 하세요~ 같이 당연한 말처럼 들린다.

하지만 막상 테스트를 적용하다보면, '이걸 정말 해야하나?'라는 생각이 든다.

테스트를 작성하는 게 그렇게 쉽지 않다. 제대로 된 테스트를 작성하려면 상당한 '노력(비용)'을 들여야 한다.

## 단위 테스트를 제대로 한다는 게 뭔데?

테스트의 목적은 우리가 믿고 변경을 할 수 있도록 만드는 것이다. 이 목적에 부합해야 '제대로 된 테스트'다.

<클린 코드>를 보면 '클린'한 테스트 코드의 원칙을 FIRST로 요약한다. (줄임말 만드는 데 천재다.) 

**Fast** 
테스트는 빨리 돌아야 한다.

**Independent**
테스트끼리 서로 의존하면 안 된다.

**Repeatable**
테스트는 어떤 환경에서도 반복가능해야 한다.

**Self-Validating**
테스트는 참/거짓으로 결과를 알려줘야 한다.

**Timely**
테스트는 실제 코드를 구현하기 직전에 구현해야 한다.

이 원칙들은 대부분 '믿고 변경할 수 있는 테스트'를 만들기 위한 것이다.

만약 True/False가 아니라 사람이 콘솔을 보고 통과 여부를 확인해야 한다면? 일단 시간이 오래 걸린다. 더 중요하게는 사람이 실수하거나 주관이 개입할 수 있다. 

코드베이스가 아닌 외부 요인에 의해서 테스트가 실패할 수 있다면? 외부 요인은 네트워크일 수도 있고, 테스트의 실행 순서일 수도 있다. 무엇이 되었든 코드는 정상인데 테스트가 실패할 수 있으면 안 된다. 테스트가 실패한 이유에 변명이 생긴다. 결과적으로 우리는 테스트를 믿을 수 있게 된다.

그 외에도 있다. 테스트는 다른 사람이 쉽게 읽을 수 있도록 가독성도 신경 써야 한다. 테스트 코드도 유지보수가 필요하기 때문이다. 

<클린 코드>에 한 회사 이야기가 나온다. 이 회사는 테스트 코드에는 '퀵 앤 더티'를 해도 괜찮다고 정했다. 그런데 실제 코드가 진화하면 테스트 코드도 진화해야 한다. 테스트 코드가 깔끔하지 않으니 그때마다 테스트 코드를 바꾸는 게 부담스러워지고, 오히려 코드를 수정하는데 방해가 된다. 결국 시간만 쓰고 테스트 케이스는 폐기된다. 

지저분한 테스트 코드는 없는 것보다도 못한 결과를 가져온다. 

아무튼 하고 싶은 말은, 제대로 된 테스트 코드는 상당히 노력의 결과물이라는 점이다. 우리는 테스트의 효과를 알고 있지만, 이 효과는 테스트의 비용과 적절히 비교해서 판단할 수 있어야 한다.

## 테스트의 '비용'은 어떻게 예측할 수 있지?

'선택적 단위 테스트'라는 글이 있다. 2009년에 쓰여진 글이다. 내가 본 단위 테스트 글 중에서 현실적인 가장 인사이트를 많이 주었다.

글쓴이는 여기서 테스트의 효과와 비용을 측정하는 간단한 기준을 하나 제시한다.

바로 코드의 '예측가능성'과 '외부 의존성'이다.

### 예측가능성이 낮을수록 테스트의 효과는 뛰어나다.

쉽게 말하면, 뻔한 코드는 테스트의 효과가 낮다. 

뻔한 코드는 코드를 딱 보고, 코드가 제대로 작동할지 명백하게 알 수 있는 코드다. 경우의 수가 적다. 단순히 프로퍼티에 값을 세팅한다든지, 저장된 값을 가져온다든지. 

하지만 반대로 까다로운 비즈니스 로직을 코딩하거나, 복잡한 문자열을 파싱하는 경우라면 어떨까. 코드를 딱 보고 우리가 떠올릴 수 있는 경우의 수보다 훨씬 더 많은 경우의 수가 있을 것이다. 이런 코드는 정확한 동작을 모두 이해하는 데 시간과 노력이 든다. 

이런 코드에서는 테스트를 통한 추가 검증이 효과적이다. 코드를 모두 이해하고, 발생할 수 있는 케이스를 모두 생각해내려고 애쓰지 않아도, 테스트 케이스가 빠르게 확인을 해줄 테니까. 이럴 때 단위 테스트는 매우매우 효과적이다.

어떤 코드에 대한 단위 테스트의 가치는 '그 코드가 얼마나 예측하기 쉬운가'로 가늠할 수 있다.

### 외부 의존성이 많을 수록 테스트의 비용은 커진다.

테스트를 깔끔하게 작성하는 것, 그것을 유지보수하는 것도 꽤 어려운 일이다. 하지만 저자는 베스트 프랙티스를 따르면 그런 문제들은 대부분 해결가능하다고 한다. 실전에서는 큰 문제가 아니라는 것이다.

테스트를 어렵게 만드는 주범은 바로 '의존성'이다.

코드에 있는 외부 의존성은 테스트를 느리게 만들거나 (Not fast), 부수 효과를 만들고 (Not isolated), 할 때마다 결과가 달라지도록 만든다. (Not repeatable)

우리가 테스트하려는 함수가 외부에 많이 의존한다면, 이것들을 대신할 가짜(테스트 더블)을 만들어내야한다. 기존 코드가 테스터블하지 않다면, 여러가지 테스트 더블을 넣기 위해서 여러가지 기법이나 외부 라이브러리를 사용해야 한다. 

더 큰 문제는, 의존성을 많이 가지는 코드일수록 변경될 가능성도 높다는 점이다. 당연하게도 해당 코드가 의존하는 모듈들은 시간이 가면 인터페이스가 바뀔 확률이 있다. 그때마다 해당 코드는 거기에 맞게 바뀌어야 한다. 

코드가 자주 바뀌면 단위 테스트도 자주 바뀌어야 한다. 의존성을 아무리 잘 분리하고 테스트가능하게 만들었더라도, 이걸 유지보수하는 비용은 피할 수 없다.

따라서 테스트의 비용은 '외부 의존성이 얼마나 많은가'에 달려있다.

## 그럼 이 기준으로 단위 테스트를 해야할 때와 말아야할 때는 구분할 수 있다는 건가?

바로 그 말이다!

이 매트릭스를 보자. 테스트의 비용과 효과를 기준으로 나눈 사분면이다. 저자의 그림을 번역해서 가져와봤다.

[그림]





