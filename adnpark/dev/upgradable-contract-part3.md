# [업그레이더블 컨트랙트 씨-리즈] Part 3 - 비콘 프록시 컨트랙트 해체 분석하기

Created: 2022년 6월 21일 오전 2:13

## **[업그레이더블 컨트랙트 씨-리즈 목차]**

Part 1 — [업그레이더블 컨트랙트란?](https://medium.com/@aiden.p/%EC%97%85%EA%B7%B8%EB%A0%88%EC%9D%B4%EB%8D%94%EB%B8%94-%EC%BB%A8%ED%8A%B8%EB%9E%99%ED%8A%B8-%EC%94%A8-%EB%A6%AC%EC%A6%88-part-1-%EC%97%85%EA%B7%B8%EB%A0%88%EC%9D%B4%EB%8D%94%EB%B8%94-%EC%BB%A8%ED%8A%B8%EB%9E%99%ED%8A%B8%EB%9E%80-b433225ebf58) 

Part 2 — [프록시 컨트랙트(Proxy Contract) 해체 분석하기](https://medium.com/@aiden.p/%EC%97%85%EA%B7%B8%EB%A0%88%EC%9D%B4%EB%8D%94%EB%B8%94-%EC%BB%A8%ED%8A%B8%EB%9E%99%ED%8A%B8-%EC%94%A8-%EB%A6%AC%EC%A6%88-part-2-%ED%94%84%EB%A1%9D%EC%8B%9C-%EC%BB%A8%ED%8A%B8%EB%9E%99%ED%8A%B8-%ED%95%B4%EC%B2%B4-%EB%B6%84%EC%84%9D%ED%95%98%EA%B8%B0-95924cb969f0)

***Part 3 — 비콘 프록시 컨트랙트(Beacon Proxy Contract) 해체 분석하기 (이번 글)***

Part 4 — 미니멀 프록시 컨트랙트(Minimal Proxy Contract) 해체 분석하기

## 들어가며

Part 1, 2를 통해 업그레이더블 컨트랙트, 그리고 이를 가능하게 해주는 다양한 프록시 패턴에 대해 살펴보았다. 그리고 나름의 베스트 프랙티스도 학습하였다. (기억이 나지 않는다면 Part 2 요약 부분(TODO: add link)을 다시 복습해보자)

프록시 패턴은 컨트랙트를 업그레이드 가능하게 만들어준다는 장점도 있지만, 한가지 장점이 더 있다. 바로 코드를 재사용 가능하도록 만들어준다는 것이다. 동일한 로직의 재사용은 일반적으로 프로그래밍에서 효율적이라고 여겨진다. 하물며 모든것이 말 그대로 돈인 컨트랙트는 굳이 더 말할것도 없을것이다.

![Untitled](%5B%E1%84%8B%E1%85%A5%E1%86%B8%E1%84%80%E1%85%B3%E1%84%85%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%83%E1%85%A5%E1%84%87%E1%85%B3%E1%86%AF%20%E1%84%8F%E1%85%A5%E1%86%AB%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%A8%E1%84%90%E1%85%B3%20%E1%84%8A%E1%85%B5-%E1%84%85%E1%85%B5%E1%84%8C%E1%85%B3%5D%20Part%203%20-%20%E1%84%87%E1%85%B5%E1%84%8F%E1%85%A9%E1%86%AB%201d282e750f9f4e68b145b4e2e6d71f81/Untitled.png)

그렇다면 프록시 패턴은 어떻게 코드를 재사용 가능하도록 만들어주는가? 이를 이해하기 위해서는 프록시 패턴의 핵심 로직을 다시 살펴볼 필요가 있다. 프록시 패턴의 핵심은 로직 컨트랙트에 실행을 위임하는 것에 있다. 여기서 한가지 주목해야 할 점은 로직 컨트랙트에 실행을 위임하는 프록시 컨트랙트는 단 하나만 존재할 이유가 없다는 것이다.

![Untitled](%5B%E1%84%8B%E1%85%A5%E1%86%B8%E1%84%80%E1%85%B3%E1%84%85%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%83%E1%85%A5%E1%84%87%E1%85%B3%E1%86%AF%20%E1%84%8F%E1%85%A5%E1%86%AB%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%A8%E1%84%90%E1%85%B3%20%E1%84%8A%E1%85%B5-%E1%84%85%E1%85%B5%E1%84%8C%E1%85%B3%5D%20Part%203%20-%20%E1%84%87%E1%85%B5%E1%84%8F%E1%85%A9%E1%86%AB%201d282e750f9f4e68b145b4e2e6d71f81/Untitled%201.png)

위 다이어그램처럼 동일한 로직 컨트랙트에 실행을 위임하는 프록시 컨트랙트는 이론상 수 없이 많을 수 있다. 이 점을 잘 활용하면 프록시 패턴을 단순히 업그레이드 목적으로 사용하는것에서 더 나아가, 컨트랙트 배포를 더 효율적으로 수행할 수 있다.

통상적으로 컨트랙트의 배포 비용은 구체적인 컨트랙트의 구현 복잡도에 따라 달라지지만, 대체로 배포시에 필요한 가스는 적게는 수십만에서 많게는 수백만 가스까지 이르게 된다. 때문에 이더리움을 기준으로 컨트랙트의 배포 비용은 매우 높은것이 현실이다. 이 글이 작성되고 있는 시점(2022년 6월 말)에서는 이더의 가격이 많이 내려와 있지만, 가격이 약 3~400만원에 육박할 때는 단순히 컨트랙트 배포만 해도 수백만원(…)이 공중에서 분해되는 기적을 볼 수 있었다. 때문에 개발자의 관점에서 컨트랙트 자체를 효율적으로 구현하는것도 매우 중요하지만, 가능하면 컨트랙트 배포 비용 또한 효율적으로 관리하는것도 중요한 요소이다. 이러한 우리의 니즈를 바로 프록시 패턴이 해결해줄 수 있는 것이다.

![Untitled](%5B%E1%84%8B%E1%85%A5%E1%86%B8%E1%84%80%E1%85%B3%E1%84%85%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%83%E1%85%A5%E1%84%87%E1%85%B3%E1%86%AF%20%E1%84%8F%E1%85%A5%E1%86%AB%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%A8%E1%84%90%E1%85%B3%20%E1%84%8A%E1%85%B5-%E1%84%85%E1%85%B5%E1%84%8C%E1%85%B3%5D%20Part%203%20-%20%E1%84%87%E1%85%B5%E1%84%8F%E1%85%A9%E1%86%AB%201d282e750f9f4e68b145b4e2e6d71f81/Untitled%202.png)

구체적인 사례를 통해 프록시 패턴이 얼마나 많은 컨트랙트 배포 비용을 절감시켜줄 수 있는지 알아보자. 크리에이터 이코노미를 다루는 가상의 프로젝트가 있다고 하자. 이 프로젝트는 크리에이터 10000명을 온보딩 시켰고, 각 크리에이터마다 그들을 위한 전용 소셜 토큰을 런칭하고자 한다. 즉, 동일한 ERC20 컨트랙트를 10000개나 배포해야 하는 상황인 것이다.

편의상 ERC20 토큰 컨트랙트 배포에 필요한 Gas가 500,000 이고, Gas Price는 $0.00005 (ETH Price $1250, 약 40 Gwei 기준)라고 가정해보자. 이 계산에 따르면 토큰 컨트랙트 배포에 필요한 비용은 $25가 된다. 한화로 약 3만원 정도의 나쁘지 않은(?) 비용이다. 하지만 우리는 1개의 ERC20 토큰 컨트랙트가 아닌, 무려 10000개의 컨트랙트를 배포해야 한다. 즉, 전체 비용은 $25가 아닌 $250,000 가 되며, 이는 약 3억원이 넘는 어마무시한 금액이 된다. 

물론 실제로 동일한 컨트랙트를 10000번이나 배포하는게 현실에서 얼마나 많이 발생할지는 모르겠지만, 컨트랙트 배포 비용이 쌓이고 쌓이면 매우 큰 금액이 된다는점은 시사할만 하다. 하지만 프록시 패턴을 사용하게 된다면? 이야기는 많이 달라진다. 프록시 컨트랙트는 대체로 로직 컨트랙트의 주소를 관리하는것과 `delegatecall`을 통한 로직 컨트랙트의 호출 부분만 구현되므로 배포시에 필요한 가스가 상당히 적은 편이다. 

TODO: UUPS 프록시 컨트랙트 배포에 필요한 가스 비용 첨부하기

- 예를 들어, 동일한 ERC20 토큰 컨트랙트를 10000개 배포해야 한다고 가정해보자.
- 그리고 편의상 토큰 컨트랙트 배포에 필요한 Gas는 500000, Gas Price는 $0.00005 (ETH Price $1250, 약 40 Gwei 기준)라고 가정해보자.
- 토큰 컨트랙트 배포에 필요한 비용은 $25 가 된다.
- 하나 정도는 배포할만 하겠지만, 만약에 동일한 컨트랙트를 10000개 배포한다면?
- 비용은 $250,000가 되며 한화로 약 3억원이 넘는 금액이 된다.
- 물론 실제로 동일한 컨트랙트를 10000번이나 배포하는게 현실에서 얼마나 많을지는 모르겠지만, 이만큼 많은 비용이 소모된다는점은 시사할만하다.
- 이를 효율적으로 할 수 있는 방법이 프록시 패턴을 활용하는 것
- 프록시 패턴의 핵심은 컨트랙트 실행의 위임에 있음
- 이는 업그레이드뿐만 아니라 다른 형태로도 활용 가능
- 로직 컨트랙트 하나만 배포해두고 동일한 로직을 사용하는 컨트랙트는 모두 프록시 컨트랙트로 구현한 뒤, 해당 로직 컨트랙트를 가리키도록 한다면?
- 복잡한 로직 컨트랙트를 배포하는 비용을 아주 단순한 프록시 컨트랙트 배포하는 비용으로 줄일 수 있다.
- TODO: 그림 추가 - 다수의 프록시 컨트랙트가 동일한 로직 컨트랙트를 가르키는 모습
- 이러한 목적으로만 프록시 패턴을 사용하는것을 Minimal Proxy라고 하는데, 이는 다음 글에서 자세히 살펴보자.
- 여기까진 모든게 다 좋아보인다.

비콘 프록시

- 기존에 배포해놓은 토큰 로직 컨트랙트에 문제가 생겨 새로운 버전으로 업그레이드 해야 하는 상황
- 그러면 어떻게 하는가? 10000개의 프록시 컨트랙트를 한땀한땀 upgradeTo()를 호출해가는 수 밖에 없다.
- 즉 10000번의 업그레이드 실행 트랜잭션이 필요하다.
- 무언가 비효율적인 느낌이 들지 않는가?
- 이 비효율을 개선하고자 나온게 바로 비콘 프록시이다.
- 비콘 프록시는 프록시와 로직 컨트랙트 사이에 비콘 컨트랙을 하나 더 둔다.
- 비콘이라는 단어의 사전적 의미는 다음과 같다.
    - 봉화나 등대와 같이 위치 정보를 전달하기 위해 어떤 신호를 주기적으로 전송하는 기기
- 즉, 비콘 컨트랙트는 말 그대로 어떤 로직 컨트랙트를 호출해야 하는지를 알려주기 위한 지표로써 역할한다.
- 프록시 컨트랙트는 항상 비콘 컨트랙트에게 어떤 로직 컨트랙트를 호출해야 하는지 물어본다.
- TODO: 프록시 - 비콘 - 로직 다이어그램
- 아까의 예시에서 업그레이드를 하려면?
- 더 이상 10000번이나 트랜잭션을 날릴 필요가 없다.
- 그냥 비콘 프록시에서 로직 컨트랙 주소만 바꿔주면 끝이다!
- O(n)이 O(1)으로 줄어드는 기적!
- 그러면 비콘 프록시는 신이고 무적인가?
- 그렇지 않다. 비콘 프록시 또한 단점이 명확하다.
- 프록시 패턴 자체가 컨트랙을 한번 거쳐서 실행하는 패턴이기 때문에 가스 비효율이 어느정도 발생하게 되는데, 비콘 프록시는 더 심하다.
- 이건 두번 거치는 꼴이니 비용이 그만큼 더 발생하게 된다.

- 비콘 프록시는 바로 로직 컨트랙트의 주소를 저장하지 않음
- 현재 버전의 로직 컨트랙트의 주소를 알려주는 비콘 컨트랙트 주소를 저장함
- TODO: BeaconProxy.sol 코드 추가
- TODO: UpgradeableBeacon 코드 추가

언제 비콘 프록시를 쓰는가?

- 동일한 로직을 사용하는 대규모의 컨트랙트를 동시에 업그레이드 해야할 필요성이 있는 경우
- 개인별 고객의 자산을 관리하는 Vault 컨트랙트가 있다.
- Vault 컨트랙트는 어카운트별로 새롭게 배포된다.
- 모든 Vault 컨트랙트의 로직은 동일하다.
- 추후 Vault 컨트랙트의 기능을 업그레이드하거나, 보안 이슈가 발생했을 때 바로 대응할 수 있어야 한다.ㅇ

요약

- 동일한 로직을 사용하는 컨트랙트를 대규모로 배포하고 동시에 업그레이드 가능하게 하려면 비콘 프록시를 사용하자
- 비콘 프록시는 무적이 아니다. 기존 프록시 패턴에 비해 컨트랙트 함수 호출에 필요한 레이어가 하나 더 추가된다. 가스 부담이 발생한다.
- 만약 동일한 로직의 컨트랙트를 대규모로 효율적으로 배포하는것 자체에만 관심이 있다면, 다음 글 미니멀 프록시를 참고해보자.

더 읽어보기

- ****Proxy Patterns For Upgradeability Of Solidity Contracts: Transparent vs UUPS Proxies****

[https://mirror.xyz/0xB38709B8198d147cc9Ff9C133838a044d78B064B/M7oTptQkBGXxox-tk9VJjL66E1V8BUF0GF79MMK4YG0](https://mirror.xyz/0xB38709B8198d147cc9Ff9C133838a044d78B064B/M7oTptQkBGXxox-tk9VJjL66E1V8BUF0GF79MMK4YG0)

[https://mixbytes.io/blog/collisions-solidity-storage-layouts](https://mixbytes.io/blog/collisions-solidity-storage-layouts)

[https://blog.logrocket.com/creating-contract-factory-clone-solidity-smart-contracts/](https://blog.logrocket.com/creating-contract-factory-clone-solidity-smart-contracts/)

- [https://twitter.com/smpalladino/status/1389939156525232130](https://twitter.com/smpalladino/status/1389939156525232130)

[https://blog.openzeppelin.com/the-transparent-proxy-pattern/](https://blog.openzeppelin.com/the-transparent-proxy-pattern/)