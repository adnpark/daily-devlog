# [솔리디티 실전 씨-리즈] 스테이킹 및 토큰 에미션 컨트랙트 구현해보기

## 들어가며

실제 크립토 프로젝트를 진행하다보면 꼭 한번쯤은 구현하게 되는 기능이 있다. 바로 토큰의 스테이킹과 그 보상 분배 로직을 구현하는 것이다. 대부분의 크립토 프로젝트라면 토큰이 존재하기 마련이고, 토큰이 존재하면 토큰의 가치 상승을 위한 수 많은 방법을 고안하기 마련이다. 이러한 방법의 일환으로 사용되는것이 바로 토큰을 스테이킹하고 그에 따른 보상을 지급하는 것이다.

![](images/2022-07-20-02-14-03.png)

토큰 스테이킹 기능은 특히 DeFi 프로젝트들이 급격하게 성장하며 상당히 빠르게 대중화 되었다. 그러다보니 어느정도 베스트 프랙티스가 정립되었는데, 그것이 바로 오늘 우리가 참고할 스시스왑의 MasterChef 컨트랙트이다. 아래 이미지에서 확인할 수 있듯이, 수 많은 토큰 스테이킹 컨트랙트들이 MasterChef 를 포크하는 형태로 구현되었다. 

![](images/2022-07-20-02-14-19.png)

따라서 이번 글에서는 MasterChef 컨트랙트를 참고하여 실제 프로덕션에서 바로 쓰일 수 있을 정도의 스테이킹 컨트랙트를 구현해보고자 한다. 하지만 MasterChef 라는 정답을 미리 보면 조금 재미가 덜하니, 스스로 스시스왑의 개발자가 되었다고 생각해보고 스테이킹 컨트랙트를 밑바닥부터 만들어가보자.

## 스테이킹 컨트랙트 구현하기

먼저 기존의 MasterChef 컨트랙트는 여러 LP 토큰을 스테이킹하고 스시토큰을 보상으로 얻을 수 있게 설계되어 있다. 하지만 우리는 조금 더 요구사항을 단순화해보자.

우리가 구현할 스테이킹 컨트랙트의 요구사항은 아래와 같다.

1. 네이티브 토큰만을 스테이킹 할 수 있다.
2. 매 블록마다 새로운 보상 토큰이 발행되며, 모든 스테이커들에게 보상으로 분배된다.
3. 각 스테이커가 받는 보상 토큰의 수량은 스테이킹한 토큰의 수량에 비례하여 결정된다.

- 여기서 핵심은 3번을 구현하는것이다. 그러면 어떻게 구현해야 할까?
- 직관적으로 생각해보자.
- 이렇게 계산해보면 될 것 같다.
- 우선 전체 스테이킹 수량 대비 상대적 지분을 구한 후 스테이킹 기간과 단위 시간당 보상을 곱해주면 될 것 같다.
- 예를 들어, 블록당 새롭게 발행되는 토큰 보상은 100개이고, 스테이킹한 유저는 철수와 영희 두명이 있다고 하자.
- 철수와 영희 모두 동일하게 5개씩 스테이킹을 했을 때, 각자 수령 가능한 토큰 보상은 블록당 50개가 된다.

![Untitled](%5B%E1%84%89%E1%85%A9%E1%86%AF%E1%84%85%E1%85%B5%E1%84%83%E1%85%B5%E1%84%90%E1%85%B5%20%E1%84%89%E1%85%B5%E1%86%AF%E1%84%8C%E1%85%A5%E1%86%AB%20%E1%84%8A%E1%85%B5-%E1%84%85%E1%85%B5%E1%84%8C%E1%85%B3%5D%20%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%8F%E1%85%B5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%90%E1%85%A9%E1%84%8F%E1%85%B3%E1%86%AB%20%E1%84%8B%E1%85%A6%E1%84%86%20b04c18ff85754fa0b0e94967a525c511/Untitled%202.png)

- 위 그림처럼 철수와 영희의 상대적 지분은 50%로 매 블록마다 동일하다.
- 따라서, 철수와 영희는 블록당 50개의 토큰 보상을 수령할 수 있게 된다.

- 이를 조금 더 일반화하여 수식으로 간단하게 나타내보면 다음과 같다.
- r = (s / ts) * t * R
- s = 스테이킹 토큰 수량
- ts = 전체 스테이킹 토큰 수량
- t = 스테이킹 기간
- R = 단위 시간당 총 토큰 보상 수량
- 즉, s / ts 는 특정 스테이커의 지분을 의미한다.

- 여기까지만 보면 문제가 쉽게 해결된 것 같은 느낌이 든다.
- 그런데 여기서 한가지 고려하지 못한점이 있다.
- 바로 스테이킹 토큰 수량과 전체 스테이킹 토큰 수량, 즉 s와 ts는 고정된 상수가 아니라 변수라는 점이다.
- 즉, 언제든지 철수와 영희는 더 많은 토큰을 스테이킹하거나, 기존의 스테이킹된 토큰을 출금할 수도 있다.
- 혹은 민수라는 새로운 친구가 갑자기 스테이킹을 할수도 있다!

- 민수와 같이 새로운 스테이커의 등장은 기존 스테이커의 스테이킹 수량 변경과 근본적으로 다르지 않으므로, 앞으로의 모든 예시에서 철수와 영희 두명의 스테이커만 존재한다고 가정하고 설명한다.

- 예를 들어, 영희가 더 많은 보상을 얻고 싶어 3번째 블록에서 10개의 토큰을 추가로 스테이킹했다면?

![Untitled](%5B%E1%84%89%E1%85%A9%E1%86%AF%E1%84%85%E1%85%B5%E1%84%83%E1%85%B5%E1%84%90%E1%85%B5%20%E1%84%89%E1%85%B5%E1%86%AF%E1%84%8C%E1%85%A5%E1%86%AB%20%E1%84%8A%E1%85%B5-%E1%84%85%E1%85%B5%E1%84%8C%E1%85%B3%5D%20%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%8F%E1%85%B5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%90%E1%85%A9%E1%84%8F%E1%85%B3%E1%86%AB%20%E1%84%8B%E1%85%A6%E1%84%86%20b04c18ff85754fa0b0e94967a525c511/Untitled%203.png)

- 3번째 블록부터는 영희의 지분이 75%로 증가하고, 철수의 지분은 25%로 감소한다.
- 그렇다면 스테이킹 보상의 수량도 다시 계산되어야 한다.
- 3번째 블록부터 철수가 블록당 얻을 수 있는 토큰 보상은 100 * 0.25 = 25 개가 된다.
- 당연하게도 영희가 얻을 수 있는 블록당 토큰 보상은 100 * 0.75 = 75 개가 된다.

- 다시 앞서 살펴본 수식으로 돌아가보자.
- r = (s / ts) * t * R
- 영희의 돌발 추가 스테이킹 케이스에서 우리가 알 수 있는것은 스테이킹 수량의 증감이 있을때마다 위 공식에 새로운 값을 대입해줘야 한다는 것이다.
- 예를 들어, 철수가 5번 블록에서 스테이킹 보상을 수령하고 싶다고 할 때, 수령가능한 보상의 양 r(0,4) 은 다음과 같이 계산되어야 한다.
- r(0,2) = (5 / 10) * 3 * 100 = 150
- r(3,4) = (5 / 20) * 2 * 100 = 50
- r(0,4) = 150 +50 = 200

- 마찬가지로 영희의 수령가능한 보상의 양 r(0,4)도 다음과 같이 계산된다.
- r(0,2) = (5 / 10) * 3 * 100 = 150
- r(3,4) = (15 / 20) * 2 * 100 = 150
- r(0,4) = 150 +50 = 300

- 여기서 유추할 수 있는것은 스테이킹 수량이 변경되는 시점마다 모든 스테이커들의 토큰 보상 계산에 변화가 발생한다는 점이다.
- 이제 이를 바탕으로 실제 컨트랙트를 구현해보자.

- 컨트랙트 이름에 Naive가 붙은 이유에 대해서는 다음 글에서 다시 다루겠다.

- 이렇게 또 문제가 해결된 것 같지만 사실 그렇지 않다.
- 여기서 알 수 있는것은 우리의 계산방식이

- 그런데 이 구현에는 심각한 문제가 있다.
- 

- 스테이킹 보상 분배 컨트랙트의 베스트 프랙티스는 스시스왑의 MasterChef 컨트랙트이다.
    
    ![Untitled](%5B%E1%84%89%E1%85%A9%E1%86%AF%E1%84%85%E1%85%B5%E1%84%83%E1%85%B5%E1%84%90%E1%85%B5%20%E1%84%89%E1%85%B5%E1%86%AF%E1%84%8C%E1%85%A5%E1%86%AB%20%E1%84%8A%E1%85%B5-%E1%84%85%E1%85%B5%E1%84%8C%E1%85%B3%5D%20%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%8F%E1%85%B5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%90%E1%85%A9%E1%84%8F%E1%85%B3%E1%86%AB%20%E1%84%8B%E1%85%A6%E1%84%86%20b04c18ff85754fa0b0e94967a525c511/Untitled%201.png)
    
- 현재 스시스왑은 새로운 스테이킹 매니저 컨트랙트를

[https://www.nansen.ai/research/all-hail-masterchef-analysing-yield-farming-activity](https://www.nansen.ai/research/all-hail-masterchef-analysing-yield-farming-activity)

## 더 읽어보기

- [https://dev.to/heymarkkop/understanding-sushiswaps-masterchef-staking-rewards-1m6f](https://dev.to/heymarkkop/understanding-sushiswaps-masterchef-staking-rewards-1m6f)
- [https://github.com/sushiswap/sushiswap/blob/archieve/canary/contracts/MasterChefV2.sol](https://github.com/sushiswap/sushiswap/blob/archieve/canary/contracts/MasterChefV2.sol)