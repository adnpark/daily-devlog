# [솔리디티 실전 씨-리즈] 스테이킹 및 토큰 에미션 컨트랙트 구현해보기

Created: 2022년 6월 3일 오전 2:29

## 들어가며

실제 크립토 프로젝트를 진행하다보면 꼭 한번쯤은 구현하게 되는 기능이 있다. 바로 토큰의 스테이킹과 그 보상 분배 로직을 구현하는 것이다. 대부분의 크립토 프로젝트라면 토큰이 존재하기 마련이고, 토큰이 존재하면 토큰의 가치 상승을 위한 수 많은 방법을 고안하기 마련이다. 이러한 방법의 일환으로 사용되는것이 바로 토큰을 스테이킹하고 그에 따른 보상을 지급하는 것이다.

![Untitled](%5B%E1%84%89%E1%85%A9%E1%86%AF%E1%84%85%E1%85%B5%E1%84%83%E1%85%B5%E1%84%90%E1%85%B5%20%E1%84%89%E1%85%B5%E1%86%AF%E1%84%8C%E1%85%A5%E1%86%AB%20%E1%84%8A%E1%85%B5-%E1%84%85%E1%85%B5%E1%84%8C%E1%85%B3%5D%20%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%8F%E1%85%B5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%90%E1%85%A9%E1%84%8F%E1%85%B3%E1%86%AB%20%E1%84%8B%E1%85%A6%E1%84%86%20b04c18ff85754fa0b0e94967a525c511/Untitled.png)

토큰 스테이킹 기능은 특히 DeFi 프로젝트들이 급격하게 성장하며 상당히 빠르게 대중화 되었다. 그러다보니 어느정도 베스트 프랙티스가 정립되었는데, 그것이 바로 오늘 우리가 참고할 스시스왑의 MasterChef 컨트랙트이다. 아래 이미지에서 확인할 수 있듯이, 수 많은 토큰 스테이킹 컨트랙트들이 MasterChef 를 포크하는 형태로 구현되었다. 

![Untitled](%5B%E1%84%89%E1%85%A9%E1%86%AF%E1%84%85%E1%85%B5%E1%84%83%E1%85%B5%E1%84%90%E1%85%B5%20%E1%84%89%E1%85%B5%E1%86%AF%E1%84%8C%E1%85%A5%E1%86%AB%20%E1%84%8A%E1%85%B5-%E1%84%85%E1%85%B5%E1%84%8C%E1%85%B3%5D%20%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%8F%E1%85%B5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%90%E1%85%A9%E1%84%8F%E1%85%B3%E1%86%AB%20%E1%84%8B%E1%85%A6%E1%84%86%20b04c18ff85754fa0b0e94967a525c511/Untitled%201.png)

따라서 이번 글에서는 MasterChef 컨트랙트를 참고하여 실제 프로덕션에서 바로 쓰일 수 있을 정도의 스테이킹 컨트랙트를 구현해보고자 한다. 하지만 MasterChef 라는 정답을 미리 보면 조금 재미가 덜하니, 스스로 스시스왑의 개발자가 되었다고 생각해보고 스테이킹 컨트랙트를 밑바닥부터 만들어가보자.

## 스테이킹 보상 계산하기

먼저 기존의 MasterChef 컨트랙트는 여러 LP 토큰을 스테이킹하고 스시토큰을 보상으로 얻을 수 있게 설계되어 있다. 하지만 우리는 요구사항을 조금 더 단순화 시켜보자.

우리가 구현할 스테이킹 컨트랙트의 요구사항은 아래와 같다.

1. 네이티브 토큰만을 스테이킹 할 수 있다.
2. 스테이킹 보상 또한 네이티브 토큰으로 지급된다. 
3. 매 블록마다 새로운 보상 토큰이 발행되며, 모든 스테이커들에게 보상으로 분배된다.
4. 각 스테이커가 받는 보상 토큰의 수량은 스테이킹한 토큰의 수량과 그 기간에 비례하여 결정된다.

여기서 핵심은 4번, 즉 스테이커들이 각자 스테이킹한 수량과 기간에 따라 얼마의 보상이 지급되어야 하는지를 계산하는 로직이다. 이를 어떻게 구현해보면 좋을까? 우선 직관의 힘을 빌려 단순하게 생각해보자.

철수라는 스테이커가 있다고 할 때, 철수가 받아야 할 스테이킹 보상은 이렇게 계산해보면 될 것 같다.

1. 우선 전체 스테이킹 수량에서 철수가 차지하는 상대적 지분을 구한다.
2. 여기에 스테이킹 기간과 단위 시간당 보상을 곱해준다. 

조금 더 이해가 쉽게 예시로 다시 살펴보자.

예를 들어, 블록당 새롭게 발행되는 토큰 보상이 100개이고, 스테이킹한 유저는 철수와 영희 두명이 있다고 하자.

![Untitled](%5B%E1%84%89%E1%85%A9%E1%86%AF%E1%84%85%E1%85%B5%E1%84%83%E1%85%B5%E1%84%90%E1%85%B5%20%E1%84%89%E1%85%B5%E1%86%AF%E1%84%8C%E1%85%A5%E1%86%AB%20%E1%84%8A%E1%85%B5-%E1%84%85%E1%85%B5%E1%84%8C%E1%85%B3%5D%20%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%8F%E1%85%B5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%90%E1%85%A9%E1%84%8F%E1%85%B3%E1%86%AB%20%E1%84%8B%E1%85%A6%E1%84%86%20b04c18ff85754fa0b0e94967a525c511/Untitled%202.png)

철수와 영희 모두 동일하게 5개씩 스테이킹을 했다면, 철수와 영희의 상대적 지분은 50%로 매 블록마다 동일한 상황이다. 따라서 철수와 영희는 모두 동일하게 50개의 스테이킹 보상을 얻게 된다. 

이를 조금 더 일반화하여 수식으로 간단하게 나타내보면 다음과 같다.

r = (s / ts) * t * R

- s = 스테이킹 수량
- ts = 전체 스테이킹 수량
- t = 스테이킹 기간
- R = 블록당 총 스테이킹 보상 수량
- 즉, s / ts 는 특정 스테이커의 지분을 의미한다.

여기까지만 보면 문제가 쉽게 해결된 것 같은 느낌이 든다. 그런데, 여기서 한가지 놓친것이 있다. 바로 스테이킹 토큰 수량과 전체 스테이킹 토큰 수량, 즉 s와 ts는 고정된 상수가 아니라 변수라는 점이다.

쉽게 말해, 철수와 영희는 언제든지 더 많은 토큰을 스테이킹하거나, 기존의 스테이킹된 토큰을 출금할 수도 있다. 혹은 민수라는 새로운 친구가 추가로 스테이킹 할수도 있다!

*물론, 민수와 같이 새로운 스테이커의 등장은 기존 스테이커의 스테이킹 수량 변경과 근본적으로 다르지 않으므로, 앞으로의 모든 예시에서 철수와 영희 두명의 스테이커만 존재한다고 가정하고 설명한다.*

예를 들어보자. 만약 영희가 더 많은 보상을 얻고 싶어 3번째 블록에서 10개의 토큰을 추가로 스테이킹했다면 어떻게 될까?

![Untitled](%5B%E1%84%89%E1%85%A9%E1%86%AF%E1%84%85%E1%85%B5%E1%84%83%E1%85%B5%E1%84%90%E1%85%B5%20%E1%84%89%E1%85%B5%E1%86%AF%E1%84%8C%E1%85%A5%E1%86%AB%20%E1%84%8A%E1%85%B5-%E1%84%85%E1%85%B5%E1%84%8C%E1%85%B3%5D%20%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%8F%E1%85%B5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%90%E1%85%A9%E1%84%8F%E1%85%B3%E1%86%AB%20%E1%84%8B%E1%85%A6%E1%84%86%20b04c18ff85754fa0b0e94967a525c511/Untitled%203.png)

3번째 블록부터는 영희의 지분이 75%로 증가하고, 철수의 지분은 25%로 감소하게 된다. 따라서, 철수와 영희의 스테이킹 보상도 다시 계산되어야 한다. 3번째 블록부터 철수가 블록당 얻을 수 있는 토큰 보상은 100 * 0.25 = 25 개가 된다. 당연하게도 영희가 얻을 수 있는 블록당 토큰 보상은 100 * 0.75 = 75 개가 된다.

여기서 다시 앞서 살펴본 수식으로 돌아가보자.

- r = (s / ts) * t * R

우리는 영희의 추가 스테이킹 사례를 통해, 스테이킹 수량의 증감이 있을때마다 위 공식에 새로운 값을 대입해줘야 한다는 것을 알게 되었다. 

예를 들어, 철수가 5번 블록에서 스테이킹 보상을 수령하고 싶다고 할 때, 수령가능한 보상의 양 r(0,4) 은 다음과 같이 계산되어야 한다.

- 0~2번 블록의 스테이킹 보상: r(0,2) = (5 / 10) * 3 * 100 = 150
- 3~4번 블록의 스테이킹 보상: r(3,4) = (5 / 20) * 2 * 100 = 50
- 0~4번 블록의 스테이킹 보상: r(0,4) = 150 +50 = 200

마찬가지로 영희의 수령가능한 보상의 양 r(0,4)도 다음과 같이 계산할 수 있다.

- r(0,2) = (5 / 10) * 3 * 100 = 150
- r(3,4) = (15 / 20) * 2 * 100 = 150
- r(0,4) = 150 +50 = 300

이 사례를 통해 확실해진것은 정확한 스테이킹 보상 수량을 구하기 위해서는, 스테이킹 수량에 변동이 있을때마다 이를 반영하여 기록해야 한다는 것이다.

그럼 이제 이론적인 이해는 충분히 했으니, 직접 컨트랙트로 구현해보자.

## 스테이킹 컨트랙트 구현하기

- 이제 이를 바탕으로 실제 컨트랙트를 구현해보자.

- 컨트랙트 이름에 Naive가 붙은 이유에 대해서는 다음 글에서 다시 다루겠다.

- 이렇게 또 문제가 해결된 것 같지만 사실 그렇지 않다.
- 여기서 알 수 있는것은 우리의 계산방식이

[https://www.nansen.ai/research/all-hail-masterchef-analysing-yield-farming-activity](https://www.nansen.ai/research/all-hail-masterchef-analysing-yield-farming-activity)

## 더 읽어보기

- [https://dev.to/heymarkkop/understanding-sushiswaps-masterchef-staking-rewards-1m6f](https://dev.to/heymarkkop/understanding-sushiswaps-masterchef-staking-rewards-1m6f)
- [https://github.com/sushiswap/sushiswap/blob/archieve/canary/contracts/MasterChefV2.sol](https://github.com/sushiswap/sushiswap/blob/archieve/canary/contracts/MasterChefV2.sol)