# [솔리디티 실전 씨-리즈] 스테이킹 및 토큰 에미션 컨트랙트 구현해보기

Created: 2022년 6월 3일 오전 2:29

## 들어가며

크립토 개발자로서 마주하는 프로젝트에는 여러 분야가 있다. DeFi, NFT(Fi), GameFi 등. 정말 다양한 분야가 있고, 서로 많이 달라 보이지만 모든 프로젝트들은 한가지 공통점이 있다. 자세히 살펴보면 모든 분야에 Fi 라는 키워드가 붙어있다. 즉, 기본적으로 크립토에서 모든 프로젝트들은 어떠한 분야든지 Financial한 측면이 있다는 것이다. 

TODO: 조금 더 인트로 설명 매끄럽게 하기

토큰화(Tokenization)은 크립토, Web3의 꽃이라고 불리기도 한다. 이 말처럼 대부분의 크립토 프로젝트들은 저마다 네이티브 토큰을 가지며, 그 토큰을 활용한 토크노믹스가 존재한다.

그리고 또 대부분의 토크노믹스에서 흔하게 접할 수 있는 패턴이 있다. 바로 프로젝트의 네이티브 토큰을 스테이킹하고, 이에 따른 스테이킹 보상, 즉 새롭게 발행된 토큰 보상(Token Emission)을 얻는것이다. 이러한 스테이킹 및 보상 로직을 구현하는 컨트랙트는 대부분의 프로젝트에서 흔히 구현되곤 한다. 

이번 글에서는 크립토 개발자로서 실제 프로젝트를 하다보면 한번쯤은 마주할 수 밖에 없는 토큰 스테이킹 보상 분배 컨트랙트를 실제로 구현해보면서 인사이트를 얻어보자.

## 스테이킹 보상 분배 컨트랙트

먼저 우리가 구현해야 할 컨트랙트의 요구사항부터 살펴보자.

요구사항은 아래와 같이 매우 단순하다.

1. 네이티브 토큰만을 스테이킹 할 수 있다.
2. 매 블록마다 새로운 보상 토큰이 발행되며, 모든 스테이커들에게 보상으로 분배된다.
3. 각 스테이커가 받는 보상 토큰의 수량은 스테이킹한 토큰의 수량에 비례하여 결정된다.

- 여기서 핵심은 3번을 구현하는것이다. 그러면 어떻게 구현해야 할까?
- 직관적으로 생각해보자.
- 이렇게 계산해보면 될 것 같다.
- 우선 전체 스테이킹 수량 대비 상대적 지분을 구한 후 스테이킹 기간과 단위 시간당 보상을 곱해주면 될 것 같다.
- 예를 들어, 블록당 새롭게 발행되는 토큰 보상은 100개이고, 스테이킹한 유저는 철수와 영희 두명이 있다고 하자.
- 철수와 영희 모두 동일하게 5개씩 스테이킹을 했을 때, 각자 수령 가능한 토큰 보상은 블록당 50개가 된다.

![Untitled](%5B%E1%84%89%E1%85%A9%E1%86%AF%E1%84%85%E1%85%B5%E1%84%83%E1%85%B5%E1%84%90%E1%85%B5%20%E1%84%89%E1%85%B5%E1%86%AF%E1%84%8C%E1%85%A5%E1%86%AB%20%E1%84%8A%E1%85%B5-%E1%84%85%E1%85%B5%E1%84%8C%E1%85%B3%5D%20%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%8F%E1%85%B5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%90%E1%85%A9%E1%84%8F%E1%85%B3%E1%86%AB%20%E1%84%8B%E1%85%A6%E1%84%86%2073b72e3d442447d7b030bfcc018e2489/Untitled.png)

- 위 그림처럼 철수와 영희의 상대적 지분은 50%로 매 블록마다 동일하다.
- 따라서, 철수와 영희는 블록당 50개의 토큰 보상을 수령할 수 있게 된다.

- 이를 조금 더 일반화하여 수식으로 간단하게 나타내보면 다음과 같다.
- r = (s / ts) * t * R
- s = 스테이킹 토큰 수량
- ts = 전체 스테이킹 토큰 수량
- t = 스테이킹 기간
- R = 단위 시간당 총 토큰 보상 수량
- 즉, s / ts 는 특정 스테이커의 지분을 의미한다.

- 여기까지만 보면 문제가 쉽게 해결된 것 같은 느낌이 든다.
- 그런데 여기서 한가지 고려하지 못한점이 있다.
- 바로 스테이킹 토큰 수량과 전체 스테이킹 토큰 수량, 즉 s와 ts는 고정된 상수가 아니라 변수라는 점이다.
- 즉, 언제든지 철수와 영희는 더 많은 토큰을 스테이킹하거나, 기존의 스테이킹된 토큰을 출금할 수도 있다.
- 혹은 민수라는 새로운 친구가 갑자기 스테이킹을 할수도 있다!

- 민수와 같이 새로운 스테이커의 등장은 기존 스테이커의 스테이킹 수량 변경과 근본적으로 다르지 않으므로, 앞으로의 모든 예시에서 철수와 영희 두명의 스테이커만 존재한다고 가정하고 설명한다.

- 예를 들어, 영희가 더 많은 보상을 얻고 싶어 3번째 블록에서 10개의 토큰을 추가로 스테이킹했다면?

![Untitled](%5B%E1%84%89%E1%85%A9%E1%86%AF%E1%84%85%E1%85%B5%E1%84%83%E1%85%B5%E1%84%90%E1%85%B5%20%E1%84%89%E1%85%B5%E1%86%AF%E1%84%8C%E1%85%A5%E1%86%AB%20%E1%84%8A%E1%85%B5-%E1%84%85%E1%85%B5%E1%84%8C%E1%85%B3%5D%20%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%8F%E1%85%B5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%90%E1%85%A9%E1%84%8F%E1%85%B3%E1%86%AB%20%E1%84%8B%E1%85%A6%E1%84%86%2073b72e3d442447d7b030bfcc018e2489/Untitled%201.png)

- 3번째 블록부터는 영희의 지분이 75%로 증가하고, 철수의 지분은 25%로 감소한다.
- 그렇다면 스테이킹 보상의 수량도 다시 계산되어야 한다.
- 3번째 블록부터 철수가 블록당 얻을 수 있는 토큰 보상은 100 * 0.25 = 25 개가 된다.
- 당연하게도 영희가 얻을 수 있는 블록당 토큰 보상은 100 * 0.75 = 75 개가 된다.

- 다시 앞서 살펴본 수식으로 돌아가보자.
- r = (s / ts) * t * R
- 영희의 돌발 추가 스테이킹 케이스에서 우리가 알 수 있는것은 스테이킹 수량의 증감이 있을때마다 위 공식에 새로운 값을 대입해줘야 한다는 것이다.
- 예를 들어, 철수가 5번 블록에서 스테이킹 보상을 수령하고 싶다고 할 때, 수령가능한 보상의 양 r(0,4) 은 다음과 같이 계산되어야 한다.
- r(0,2) = (5 / 10) * 3 * 100 = 150
- r(3,4) = (5 / 20) * 2 * 100 = 50
- r(0,4) = 150 +50 = 200

- 마찬가지로 영희의 수령가능한 보상의 양 r(0,4)도 다음과 같이 계산된다.
- r(0,2) = (5 / 10) * 3 * 100 = 150
- r(3,4) = (15 / 20) * 2 * 100 = 150
- r(0,4) = 150 +50 = 300

- 여기서 유추할 수 있는것은 스테이킹 수량이 변경되는 시점마다 모든 스테이커들의 토큰 보상 계산에 변화가 발생한다는 점이다.
- 이제 이를 바탕으로 실제 컨트랙트를 구현해보자.

- 컨트랙트 이름에 Naive가 붙은 이유에 대해서는 다음 글에서 다시 다루겠다.

- 이렇게 또 문제가 해결된 것 같지만 사실 그렇지 않다.
- 여기서 알 수 있는것은 우리의 계산방식이

- 그런데 이 구현에는 심각한 문제가 있다.
- 

- 스테이킹 보상 분배 컨트랙트의 베스트 프랙티스는 스시스왑의 MasterChef 컨트랙트이다.
    
    ![Untitled](%5B%E1%84%89%E1%85%A9%E1%86%AF%E1%84%85%E1%85%B5%E1%84%83%E1%85%B5%E1%84%90%E1%85%B5%20%E1%84%89%E1%85%B5%E1%86%AF%E1%84%8C%E1%85%A5%E1%86%AB%20%E1%84%8A%E1%85%B5-%E1%84%85%E1%85%B5%E1%84%8C%E1%85%B3%5D%20%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%8F%E1%85%B5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%90%E1%85%A9%E1%84%8F%E1%85%B3%E1%86%AB%20%E1%84%8B%E1%85%A6%E1%84%86%2073b72e3d442447d7b030bfcc018e2489/Untitled%202.png)
    
- 현재 스시스왑은 새로운 스테이킹 매니저 컨트랙트를

[https://www.nansen.ai/research/all-hail-masterchef-analysing-yield-farming-activity](https://www.nansen.ai/research/all-hail-masterchef-analysing-yield-farming-activity)

## 더 읽어보기

- [https://dev.to/heymarkkop/understanding-sushiswaps-masterchef-staking-rewards-1m6f](https://dev.to/heymarkkop/understanding-sushiswaps-masterchef-staking-rewards-1m6f)
- [https://github.com/sushiswap/sushiswap/blob/archieve/canary/contracts/MasterChefV2.sol](https://github.com/sushiswap/sushiswap/blob/archieve/canary/contracts/MasterChefV2.sol)